define ("block_mynotes/mynotesblock",["jquery","core/yui","core/str","core/config","core/notification"],function(c,a,b){var d,e={DELETE_ICON:"<span class=\"delete\">&#x274C;</span>"},f={MYNOTES_BASE:"#mynotes_base",MYNOTES_OPENER:".mynotes-opener",MYNOTES_LISTS:".mynotes_list"},g={MYNOTES_BASE:"mynotes_base",MYNOTES_OPENER:"mynotes-opener",MYNOTES_LISTS:"mynotes_list"},h=null,j=null,k=M.util.get_string("deletemynotes","block_mynotes"),l={getMynotesValidatedUrl:function getMynotesValidatedUrl(b){var c=document.createElement("a");c.href=b;return 0<c.search.length?b:b+"?"},getWarnings:function getWarnings(a){if(!1==a){c("#addmynote-label-"+d.instanceid+"  span.warning").html(d.maxallowedcharacters_warning)}else{var b=c("#id_mynotecontent-"+d.instanceid);if(""==b.val()){c("#addmynote-label-"+d.instanceid+"  span.warning").html("")}else{var e=d.maxallowedcharacters-b.val().length;c("#addmynote-label-"+d.instanceid+"  span.warning").html(M.util.get_string("charactersleft","block_mynotes")+e)}}},checkInputText:function checkInputText(){var a=c("#id_mynotecontent-"+d.instanceid);if(a.val().length<=d.maxallowedcharacters){c("#addmynote_submit").removeAttr("disabled","");return!0}else{c("#addmynote_submit").attr("disabled","disabled");return!1}return!0},toggle_textarea:function toggle_textarea(a){var b=c("#id_mynotecontent-"+d.instanceid);if(!b){return!1}var e="focusin"==a.type;if(e){if(b.val()==M.util.get_string("placeholdercontent","block_mynotes")){b.val("");c(".textarea").css("border-color","black")}}else{if(""==b.val()){b.val(M.util.get_string("placeholdercontent","block_mynotes"));c(".textarea").css("border-color","gray");c("#addmynote-label-"+d.instanceid+"  span.warning").html("")}}},request:function request(b){var c={},e=this;if(b.scope){e=b.scope}c.contextarea=e.currenttab.replace(d.prefix,"");c.contextarea=c.contextarea.replace("#","");if(b.params){for(i in b.params){c[i]=b.params[i]}}c.sesskey=M.cfg.sesskey;var f={method:"POST",on:{start:function start(){},complete:function complete(c,d,e){if(!d){alert("IO FATAL");return!1}var f=a.JSON.parse(d.responseText);if(f.error){if("require_login"==f.error){b.callback(c,f,e);return!0}alert(f.error);return!1}else{b.callback(c,f,e);return!0}}},arguments:{scope:e},headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},data:build_querystring(c)};if(b.form){f.form=b.form}a.io(this.api,f)},saveMynotes:function saveMynotes(a){a.preventDefault();var b=this;if(!1==b.checkInputText()){return!1}var e=c("#id_mynotecontent-"+d.instanceid);if(""==e.val()||e.val()==M.util.get_string("placeholdercontent","block_mynotes")){return!1}var g={contextid:d.contextid,content:e.val(),action:"add",contextarea:b.currenttabindex};e.attr("disabled",!0);e.css({backgroundImage:"url("+M.util.image_url("i/loading_small","core")+")",backgroundRepeat:"no-repeat",backgroundPosition:"center center"});this.request({params:g,callback:function callback(a,e){if(!e.notes){return!1}c("#addmynote-label-"+d.instanceid+"  span.warning").html("");c("#id_mynotecontent-"+d.instanceid).val(M.util.get_string("placeholdercontent","block_mynotes"));c("#id_mynotecontent-"+d.instanceid).removeAttr("disabled");c("#id_mynotecontent-"+d.instanceid).css({backgroundImage:""});if(b.currenttab!=b.defaulttab){b.currenttab=b.defaulttab;var g=b.currenttab.replace("#","#tab-");c(f.MYNOTES_BASE+" ul.tabs-menu li").removeClass("current");c(f.MYNOTES_BASE+" "+g).addClass("current");c(f.MYNOTES_BASE+" .tab-content").has(b.currenttab).addClass("current");c(f.MYNOTES_BASE+" .tab-content").not(b.currenttab).css("display","none");c(f.MYNOTES_BASE+" "+b.currenttab+".tab-content").css("display","block")}b.addToList(e,"add");b.displayMynotes();c(f.MYNOTES_BASE).find(".responsetext").html(M.util.get_string("savedsuccess","block_mynotes"))}})},addToList:function addToList(a){var b=1<arguments.length&&arguments[1]!==void 0?arguments[1]:"",d=this,e=c(f.MYNOTES_BASE).find(d.currenttab+"-list");if("add"==b){e.prepend(d.renderMynotes(a.notes))}else{e.append(d.renderMynotes(a.notes));c(e).find("li").sort(function sort_li(d,a){return c(a).data("itemid")>c(d).data("itemid")?1:-1}).appendTo(e)}c(f.MYNOTES_BASE).find(d.currenttab).attr("notes-count",a.count)},getMynotes:function getMynotes(){var a=0<arguments.length&&arguments[0]!==void 0?arguments[0]:0,b=this;a=parseInt(a);var e=c(f.MYNOTES_BASE).find(b.currenttab+"-list"),g=e.find("li").length,h=Math.ceil(g/d.perpage);if(0<g&&h>a){b.displayMynotes();return!1}var j={contextid:d.contextid,action:"get",page:a};this.request({params:j,callback:function callback(a,c){b.addToList(c);b.displayMynotes()}})},updateMynotesInfo:function updateMynotesInfo(a,b){b=parseInt(b);a=parseInt(a);var e=this,g="";if(a>d.perpage){var h=b-1,j="",k="";if(0<b){j=e.createLink(h,M.util.get_string("previouspage","block_mynotes"),"previous")}if(0<d.perpage){var l=Math.ceil(a/d.perpage)}else{var l=1}h=b+1;if(h!=l){k=e.createLink(h,M.util.get_string("nextpage","block_mynotes"),"next")}g=j;if(""!=j&&""!=k){g+="<span class=\"separator\"></span>"}g+=k;g="<span class=\"paging\">"+g+"</span>"}var m=c(f.MYNOTES_BASE).find(e.currenttab);if(0<a){m.find(".count").html(M.util.get_string("mynotescount","block_mynotes")+""+a)}else{m.find(".count").html(M.util.get_string("nothingtodisplay","block_mynotes"))}m.find(".mynotes-paging").html(g)},renderMynotes:function renderMynotes(a){if(1>a.length){return!1}var b="",f="";for(f in a){c("#mynote-"+d.instanceid+"-"+a[f].id).remove();var g="<a href=\"#\" id=\"mynote-delete-"+d.instanceid+"-"+a[f].id+"\" class=\"mynote-delete\" title=\""+k+"\">"+e.DELETE_ICON+"</a>",h="";if(""!=a[f].coursename){h="<div class=\"note-detail\">"+a[f].coursename+" - </div>"}var j="<div class=\"time\">"+a[f].timecreated+"</div>",l="<div class=\"content\">"+g+a[f].content+"</div>";b+="<li id=\"mynote-"+d.instanceid+"-"+a[f].id+"\" data-itemid=\""+a[f].id+"\">"+l+h+j+"</li>"}return b},createLink:function createLink(a,b,c){var d="undefined"!=typeof c?" class=\""+c+"\"":"";return"<a href=\""+this.api+"&page="+a+"\""+d+">"+b+"</a>"},displayMynotes:function displayMynotes(){var a=this,b=parseInt(c(f.MYNOTES_BASE).find(a.currenttab).attr("onpage")),e=parseInt(c(f.MYNOTES_BASE).find(a.currenttab).attr("notes-count")),g=c(f.MYNOTES_BASE).find(" "+a.currenttab+"-list"),h=g.find("li").length,j=Math.ceil(h/d.perpage);if(0<h&&j<=b){b=j-1}var k=b*d.perpage+d.perpage,l=b*d.perpage;g.find("li").css("display","none");g.find("li").each(function(a,b){if(a>=l&&a<k){c(b).css("display","block")}});a.updateMynotesInfo(e,b)},registerActions:function registerActions(){var a=this;c("body").delegate("#addmynote_cancel","click",function(){h.hide()});c("body").delegate("#addmynote_submit","click",function(b){a.saveMynotes(b)});c("body").delegate(f.MYNOTES_BASE+" ul.tabs-menu li","click",function(){c(this).addClass("current");c(this).siblings().removeClass("current");var b=c(this).attr("id").replace("tab-","");c(f.MYNOTES_BASE+" .tab-content").not("#"+b).css("display","none");c(f.MYNOTES_BASE+" #"+b+".tab-content").css("display","block");a.currenttab="#"+b;var d=c(a.currenttab).attr("data-loaded");if("undefined"==typeof d||!1==d){c(f.MYNOTES_BASE).find(a.currenttab).attr("data-loaded","true");a.getMynotes(0)}});c("body").delegate("#id_mynotecontent-"+d.instanceid,"focus blur",function(b){a.toggle_textarea(b)});c("body").delegate("#id_mynotecontent-"+d.instanceid,"change keypress keyup",function(){a.getWarnings(a.checkInputText())});c("body").delegate(f.MYNOTES_BASE+" .mynotes-paging .paging a","click",function(b){b.preventDefault();var d=new RegExp(/[\?&]page=(\d+)/),e=d.exec(c(this).attr("href")),g=0;if(e[1]){g=e[1]}c(f.MYNOTES_BASE).find(a.currenttab).attr("onpage",parseInt(g));a.getMynotes(g)});c("body").delegate(f.MYNOTES_BASE+" a.mynote-delete","click",function(b){b.preventDefault();var e=c(this).attr("id");if(""!=e||"undefined"!=e){var g=c(f.MYNOTES_BASE).find(f.MYNOTES_LISTS+"-"+a.currenttab+" > li").length,h=e.replace("mynote-delete-"+d.instanceid+"-",""),j={contextid:d.contextid,action:"delete",noteid:h,lastnotecounts:g};a.request({params:j,callback:function callback(a,b,e){e.scope.addToList(b);c("#mynote-"+d.instanceid+"-"+b.noteid).remove();e.scope.displayMynotes()}})}})},displayDialogue:function displayDialogue(){var e=l;if(null===h){b.get_strings([{key:"mynotes",component:"block_mynotes"},{key:"characterlimit",component:"block_mynotes"},{key:"save",component:"block_mynotes"},{key:"cancel"},{key:"mynotessavedundertab",component:"block_mynotes",param:d.contextareas[e.currenttabindex]},{key:"placeholdercontent",component:"block_mynotes"}]).done(function(b){var k=c("<div></div>").append(c("<div id=\""+g.MYNOTES_BASE+"\" class=\""+g.MYNOTES_BASE+"\"></div>").append("<div class=\"inputarea\"><div class=\"responsetext\"></div><div id=\"addmynote-label-"+d.instanceid+"\">"+b[1]+" "+d.maxallowedcharacters+"<span class=\"warning\"></span></div><div class=\"textarea\"><textarea id=\"id_mynotecontent-"+d.instanceid+"\" name=\"mynotecontent\" rows=\"2\">"+b[5]+"</textarea></div><p class=\"notesavedhint\">"+b[4]+"</p><p class=\"mdl-align\"><input type=\"submit\" id=\"addmynote_submit\"/></p></div>").append(c("<ul class=\"tabs-menu\"></ul>")).append(c("<div class=\"tab\"></div>")));k.find("#addmynote_submit").attr("value",b[2]);k.find("#addmynote_cancel").attr("value",b[3]);var l="",m="",n="";for(n in d.contextareas){if(e.currenttabindex==n){l+="<li class=\"current\" id=\"tab-"+d.prefix+n+"\"><div class=\"menu-item\">"+d.contextareas[n]+"</div></li>"}else{l+="<li class=\"\" id=\"tab-"+d.prefix+n+"\"><div class=\"menu-item\">"+d.contextareas[n]+"</div></li>"}m+="<div class=\"tab-content\" id=\""+d.prefix+n+"\" onpage=\"0\" notes-count=\"0\"><div class=\"notes-info\"><div class=\"mynotes-paging\"></div><div class=\"count\"></div></div><ul id=\""+d.prefix+n+"-list\" class=\"mynotes_lists\"></ul></div>"}k.find(".tabs-menu").append(l);k.find(".tab").append(c(m));a.use("moodle-core-notification-dialogue",function(){h=new M.core.dialogue({draggable:!0,modal:!0,closeButton:!0,headerContent:M.util.get_string("mynotes","block_mynotes"),responsive:!0});h.set("bodyContent",k.html());if(null===j){j=!0;e.getMynotes(0);c(f.MYNOTES_BASE).find(e.currenttab).attr("data-loaded","true");c(f.MYNOTES_BASE).find(e.currenttab).css("display","block")}h.show()});e.registerActions()})}else{h.show()}},init:function init(a){d=a;d.prefix="mynotes_";this.perpage=parseInt(d.perpage);this.currenttab="#mynotes_"+a.currenttabindex;this.defaulttab="#mynotes_"+a.currenttabindex;this.currenttabindex=a.currenttabindex;this.api=this.getMynotesValidatedUrl(M.cfg.wwwroot+"/blocks/mynotes/mynotes_ajax.php");var b=M.util.get_string("showmynotes","block_mynotes");if(!d.editing){var e=c("<div class=\""+g.MYNOTES_OPENER+"\" title=\""+b+"\" alt=\""+b+"\">"+M.util.get_string("mynotes","block_mynotes")+"</div>");e.addClass(d.editingicon_pos);c("body").append(e);e.html("<span class=\"pencil\">&#x270D;</span>")}else{var e=c("<div class=\""+g.MYNOTES_OPENER+"\" title=\""+b+"\" alt=\""+b+"\">"+M.util.get_string("mynotes","block_mynotes")+"</div>");e.addClass(d.editingicon_pos);e.html("<span class=\"pencil\">&#x270D;</span>");c(".inline-"+g.MYNOTES_OPENER).html(e);c(".inline-"+g.MYNOTES_OPENER).append("<div class=\"mynotes-pos-inline-text "+g.MYNOTES_OPENER+"\">"+b+"</div>")}var h=c("body");h.delegate(f.MYNOTES_OPENER,"click",this.displayDialogue)}};return l});
//# sourceMappingURL=mynotesblock.min.js.map
